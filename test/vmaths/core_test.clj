(ns vmaths.core-test
  (:require [clojure.test :refer :all]
            [vmaths.core :refer :all]
            [clojure.core.matrix :as ma]))

(ma/set-current-implementation :vectorz)

(deftest floats-test
  (testing "Floats"
    (is (= (float= 1.0 1.0) true))
    (is (= (float= 1 1.0) true))
    (is (= (float= 1.0 2.0) false))
    (is (= (float< 1.0 1.0) false))
    (is (= (float< 3.0 2.0) false))
    (is (= (float< 1.0 2.0) true))
    (is (= (float<= 1.0 2.0) true))
    (is (= (float<= 1.0 1.0) true))
    (is (= (float<= 1.0 0) false))
    (is (= (float> 1.0 2.0) false))
    (is (= (float> 2.0 1.0) true))
    (is (= (float> 1.0 1.0) false))
    (is (= (float>= 1.0 1.0) true))
    (is (= (float>= 3.0 2.0) true))
    (is (= (float>= 1.0 2.0) false))))

(deftest vectors-test
  (let [v1 [4 15 16 18 32 0 39 32 15 19]
        v2 [7 38 29 23 11 32 25 5 34 17]]
    (testing "Vector"
      (is (= (mean v1) 19.0))
      (is (= (variance v1) 151.77777777777777))
      (is (= (pop-variance v1) 136.6))
      (is (= (ssd v1) 12.31981240838422))
      (is (= (psd v1) 11.687600266949584))
      (is (= (mad v1) 7.5))
      (is (= (meanad v1) 9.0))
      (mapv #(is (= (quantile v1 0.75 %1) %2))
            (range 1 10)
            [32.0 32.0 32.0 25.5 32.0 32.0 28.75 32.0 32.0])
      (is (= (median v2) 24.0))
      (is (= (mode v1) '(15 32)))
      (is (= (vrange v1) 39))
      (is (= (midrange v1) 19.5))
      (is (= (euclidean v1 v2) 59.0508255657785))
      (is (= (euclidean-squared v1 v2) 3487))
      (is (= (manhattan v1 v2) 159.0))
      (is (= (mae v1 v2) 15.9))
      (is (= (canberra v1 v2) 3.9976921256286575))
      (is (= (pearson v1 v2) -0.31231702416919843))
      (is (= (cosine v1 v2) 0.6888336157182211)))
    (testing "Normalization"
      (is (= (first (first (normalise v1 standard-score)))
             -1.2175510066851167))
      (is (= (first (first (normalise v1 positional-standardization)))
             -1.1691173164260984))
      (is (= (first (first (normalise v1 unitization)))
             -0.38461538461538464))
      (is (= (first (first (normalise v1 positional-unitization)))
             -0.3333333333333333))
      (is (= (first (first (normalise v1 unitization-zero-min)))
             0.1025641025641026))
      (is (= (first (first (normalise v1 norm-in-range)))
             -0.75))
      (is (= (first (first (normalise v1 positional-norm-in-range)))
             -0.5909090909090909))
      (is (= (first (first (normalise v1 quotient-trans)))
             0.3246802684493645))
      (is (= (first (first (normalise v1 positional-quotient-trans)))
             0.35972840505418413))
      (is (= (first (first (normalise v1 quotient-trans-range)))
             0.1025641025641026))
      (is (= (first (first (normalise v1 quotient-trans-max)))
             0.1025641025641026))
      (is (= (first (first (normalise v1 quotient-trans-mean)))
             0.21052631578947367))
      (is (= (first (first (normalise v1 positional-quotient-trans-median)))
             0.23529411764705882))
      (is (= (first (first (normalise v1 quotient-trans-sum)))
             0.02105263157894737))
      (is (= (first (first (normalise v1 normalization)))
             -0.40585033556170563))
      (is (= (first (first (normalise v1 positional-norm)))
             -0.3466974855907322))
      (is (= (first (first (normalise v1 norm-central-zero)))
             -0.7948717948717948))
      (is (= (first (first (normalise v1 unit)))
             0.05670479771237427))
      (is (= (first (first (first (normalise [v1 v2] standard-score))))
             -0.7071067811865476))
      (is (= (first (first (first (normalise [v1 v2] standard-score :dir :rows))))
             -1.2175510066851167)))))

(deftest core-matrix-test
  (let [v1  (ma/array [4 15 16 18 32 0 39 32 15 19])
        v2 (ma/array [7 38 29 23 11 32 25 5 34 17])]
    (testing "Core matrix"
      (is (= (mean v1) 19.0))
      (is (= (variance v1) 151.77777777777777))
      (is (= (pop-variance v1) 136.6))
      (is (= (ssd v1) 12.31981240838422))
      (is (= (psd v1) 11.687600266949584))
      (is (= (mad v1) 7.5))
      (is (= (meanad v1) 9.0))
      (mapv #(is (= (quantile v1 0.75 %1) %2))
            (range 1 10)
            [32.0 32.0 32.0 25.5 32.0 32.0 28.75 32.0 32.0])
      (is (= (median v2) 24.0))
      (is (= (mode v1) [15.0 32.0]))
      (is (= (vrange v1) 39.0))
      (is (= (midrange v1) 19.5))
      (is (= (euclidean v1 v2) 59.0508255657785))
      (is (= (euclidean-squared v1 v2) 3487.0))
      (is (= (manhattan v1 v2) 159.0))
      (is (= (mae v1 v2) 15.9))
      (is (= (canberra v1 v2) 3.9976921256286575))
      (is (= (pearson v1 v2) -0.3123170241691985))
      (is (= (cosine v1 v2) 0.6888336157182211)))
    (testing "Normalization"
      (is (= (first (first (normalise v1 standard-score)))
             -1.2175510066851167))
      (is (= (first (first (normalise v1 positional-standardization)))
             -1.1691173164260984))
      (is (= (first (first (normalise v1 unitization)))
             -0.38461538461538464))
      (is (= (first (first (normalise v1 positional-unitization)))
             -0.3333333333333333))
      (is (= (first (first (normalise v1 unitization-zero-min)))
             0.10256410256410256))
      (is (= (first (first (normalise v1 norm-in-range)))
             -0.75))
      (is (= (first (first (normalise v1 positional-norm-in-range)))
             -0.5909090909090909))
      (is (= (first (first (normalise v1 quotient-trans)))
             0.3246802684493645))
      (is (= (first (first (normalise v1 positional-quotient-trans)))
             0.35972840505418413))
      (is (= (first (first (normalise v1 quotient-trans-range)))
             0.10256410256410256))
      (is (= (first (first (normalise v1 quotient-trans-max)))
             0.10256410256410256))
      (is (= (first (first (normalise v1 quotient-trans-mean)))
             0.21052631578947367))
      (is (= (first (first (normalise v1 positional-quotient-trans-median)))
             0.23529411764705882))
      (is (= (first (first (normalise v1 quotient-trans-sum)))
             0.021052631578947368))
      (is (= (first (first (normalise v1 normalization)))
             -0.40585033556170563))
      (is (= (first (first (normalise v1 positional-norm)))
             -0.3466974855907322))
      (is (= (first (first (normalise v1 norm-central-zero)))
             -0.7948717948717948))
      (is (= (first (first (normalise v1 unit)))
             0.05670479771237427))
      (is (= (first (first (first (normalise (ma/matrix [v1 v2]) standard-score))))
             -0.7071067811865476))
      (is (= (first (first (first (normalise (ma/matrix [v1 v2]) standard-score
                                             :dir :rows))))
             -1.2175510066851167)))))

